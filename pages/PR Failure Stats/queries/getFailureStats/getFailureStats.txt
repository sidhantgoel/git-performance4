Select pull_request_id, json_agg(json_build_object('commit_id', commit_id, 'lt', lt_failures, 'st', st_failures, 'tot', tot_failures, 'created_at', created_at)) as values from (SELECT pull_request_id, commit_id, min(lt_median_failure+lt_min_failure) as lt_failures, min(st_median_failure+st_min_failure) as st_failures, min(lt_median_failure+lt_min_failure+st_median_failure+st_min_failure) as tot_failures,  max(created_at) as created_at from run_meta where lt_median_failure is NOT NULL AND lt_min_failure is NOT NULL  AND pull_request_id > 0 AND created_at between '{{StartDate.formattedDate}}' and '{{EndDate.formattedDate}}'GROUP BY pull_request_id, commit_id) as stats_data group by pull_request_id;